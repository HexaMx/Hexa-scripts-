local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Camera = workspace.CurrentCamera

local localPlayer = Players.LocalPlayer
local mouse = localPlayer:GetMouse()

local pg = localPlayer:WaitForChild("PlayerGui")
local old = pg:FindFirstChild("FPS_DUELS")
if old then old:Destroy() end

local gui = Instance.new("ScreenGui", pg)
gui.Name = "FPS_DUELS"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- [[ 1. SETUP MAIN FRAME (HIDDEN AT FIRST) ]] --
local main = Instance.new("Frame", gui)
main.Size = UDim2.fromScale(0.45, 0.45)
main.Position = UDim2.fromScale(0.275, 0.275)
main.BackgroundColor3 = Color3.fromRGB(20,20,20)
main.Visible = false -- HIDE MENU INITIALLY

-- [[ 2. ROBUST INTRO SEQUENCE ]] --
local introFrame = Instance.new("Frame", gui)
introFrame.Name = "Intro"
introFrame.Size = UDim2.fromScale(1, 1)
introFrame.Position = UDim2.fromScale(0, 0)
introFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
introFrame.BorderSizePixel = 0
introFrame.ZIndex = 9999 -- Force on top of EVERYTHING

local welcomeLabel = Instance.new("TextLabel", introFrame)
welcomeLabel.Size = UDim2.fromScale(1, 1)
welcomeLabel.BackgroundTransparency = 1
welcomeLabel.Text = "Welcome, " .. localPlayer.DisplayName
welcomeLabel.TextColor3 = Color3.fromRGB(255, 255, 255) -- Pure White
welcomeLabel.Font = Enum.Font.GothamBold
welcomeLabel.TextSize = 40
welcomeLabel.ZIndex = 10000 -- On top of frame
welcomeLabel.TextTransparency = 0 -- VISIBLE IMMEDIATELY

-- Animation Logic
task.spawn(function()
	task.wait(2.5) -- Show text for 2.5 seconds
	
	-- Slide Up Animation
	local tweenInfo = TweenInfo.new(0.7, Enum.EasingStyle.Quart, Enum.EasingDirection.In)
	local slide = TweenService:Create(introFrame, tweenInfo, {Position = UDim2.fromScale(0, -1)})
	slide:Play()
	
	-- When slide finishes, Show Menu and Destroy Intro
	slide.Completed:Wait()
	main.Visible = true -- SHOW MENU NOW
	introFrame:Destroy()
end)
-- [[ END INTRO ]] --

-- [[ 3. MAIN GUI CONTENT ]] --
local titleBar = Instance.new("Frame", main)
titleBar.Size = UDim2.fromScale(1, 0.12)
titleBar.BackgroundColor3 = Color3.fromRGB(15,15,15)

local title = Instance.new("TextLabel", titleBar)
title.Size = UDim2.fromScale(0.85, 1)
title.Text = "FPS DUELS by Hexa"
title.TextScaled = true
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1

local minimize = Instance.new("TextButton", titleBar)
minimize.Size = UDim2.fromScale(0.15, 1)
minimize.Position = UDim2.fromScale(0.85, 0)
minimize.Text = "-"
minimize.TextScaled = true
minimize.Font = Enum.Font.GothamBold
minimize.TextColor3 = Color3.new(1,1,1)
minimize.BackgroundColor3 = Color3.fromRGB(35,35,35)

local tabs = Instance.new("Frame", main)
tabs.Size = UDim2.fromScale(1, 0.12)
tabs.Position = UDim2.fromScale(0, 0.12)
tabs.BackgroundTransparency = 1

local content = Instance.new("Frame", main)
content.Size = UDim2.fromScale(1, 0.76)
content.Position = UDim2.fromScale(0, 0.24)
content.BackgroundColor3 = Color3.fromRGB(25,25,25)

local function makeTab(name, pos)
	local b = Instance.new("TextButton", tabs)
	b.Size = UDim2.fromScale(0.33, 1)
	b.Position = UDim2.fromScale(pos, 0)
	b.Text = name
	b.TextScaled = true
	b.Font = Enum.Font.Gotham
	b.TextColor3 = Color3.new(1,1,1)
	b.BackgroundColor3 = Color3.fromRGB(30,30,30)
	return b
end

local mapTab = makeTab("Map", 0)
local pvpTab = makeTab("Pvp", 0.33)
local utilTab = makeTab("Utils", 0.66)

local pages = {}
for i,n in ipairs({"Map","Pvp","Utils"}) do
	local f = Instance.new("Frame", content)
	f.Size = UDim2.fromScale(1,1)
	f.Visible = i==1
	f.BackgroundTransparency = 1
	pages[n] = f
end

local function switch(tab)
	for _,v in pairs(pages) do v.Visible = false end
	pages[tab].Visible = true
end

mapTab.MouseButton1Click:Connect(function() switch("Map") end)
pvpTab.MouseButton1Click:Connect(function() switch("Pvp") end)
utilTab.MouseButton1Click:Connect(function() switch("Utils") end)

local function tpButton(text, y, cf)
	local b = Instance.new("TextButton", pages.Map)
	b.Size = UDim2.fromScale(0.5, 0.14)
	b.Position = UDim2.fromScale(0.25, y)
	b.Text = text
	b.TextScaled = true
	b.Font = Enum.Font.GothamBold
	b.TextColor3 = Color3.new(1,1,1)
	b.BackgroundColor3 = Color3.fromRGB(60,60,60)
	b.MouseButton1Click:Connect(function()
		local c = localPlayer.Character
		if not c then return end
		local h = c:FindFirstChild("HumanoidRootPart")
		if not h then return end
		h.CFrame = cf * CFrame.new(0,5,0)
	end)
end

tpButton("Tp Straps",0.06,CFrame.new(-608.499512,6.00024414,-438.000122,1,0,0,0,1,0,0,0,1))
tpButton("Tp Arenas",0.22,CFrame.new(-608.499512,6.00024414,-390.000122,-1,0,0,0,1,0,0,0,-1))
tpButton("Tp Boards",0.38,CFrame.new(-584.499023,6.00036621,-414.000122,0,0,-1,0,1,0,1,0,0))
tpButton("Tp Spectate",0.54,CFrame.new(-632.499023,6.00036621,-414.000122,0,0,-1,0,1,0,1,0,0))

-- PvP Toggles
local espConnections = {}
local espContainer = Instance.new("Folder", game.CoreGui)
espContainer.Name = "HexaESP"

local function toggleButton(text, y, parent, callback)
	local state = false
	local b = Instance.new("TextButton", parent)
	b.Size = UDim2.fromScale(0.6,0.16)
	b.Position = UDim2.fromScale(0.2,y)
	b.Text = text.." : OFF"
	b.TextScaled = true
	b.Font = Enum.Font.GothamBold
	b.TextColor3 = Color3.new(1,1,1)
	b.BackgroundColor3 = Color3.fromRGB(70,30,30)
	b.MouseButton1Click:Connect(function()
		state = not state
		b.Text = text..(state and " : ON" or " : OFF")
		b.BackgroundColor3 = state and Color3.fromRGB(30,70,30) or Color3.fromRGB(70,30,30)
		if callback then callback(state) end
	end)
	return function() return state end
end

local AimBotEnabled = toggleButton("Aim Bot",0.05,pages.Pvp)
local SmoothEnabled = toggleButton("Smooth Aimbot",0.25,pages.Pvp)

-- ESP Functionality
local function updateESP(state)
	espContainer:ClearAllChildren()
	if not state then return end
	
	local function createHighlight(plr)
		if plr == localPlayer then return end
		if not plr.Character then return end
		
		local highlight = Instance.new("Highlight")
		highlight.Name = plr.Name
		highlight.Adornee = plr.Character
		highlight.FillColor = Color3.fromRGB(255, 0, 0)
		highlight.FillTransparency = 0.5
		highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
		highlight.OutlineTransparency = 0
		highlight.Parent = espContainer
		
		-- Clean up if player dies or leaves
		plr.CharacterRemoving:Connect(function()
			if highlight then highlight:Destroy() end
		end)
	end
	
	-- Add ESP to existing players
	for _, p in ipairs(Players:GetPlayers()) do
		createHighlight(p)
		p.CharacterAdded:Connect(function()
			task.wait(0.5) -- Wait for character to load
			if EspEnabled() then createHighlight(p) end
		end)
	end
	
	-- Handle new players
	Players.PlayerAdded:Connect(function(p)
		p.CharacterAdded:Connect(function()
			task.wait(0.5)
			if EspEnabled() then createHighlight(p) end
		end)
	end)
end

EspEnabled = toggleButton("ESP", 0.45, pages.Pvp, updateESP)

-- Smoothness Slider
pcall(function()
	local oldSlider = localPlayer.PlayerGui:FindFirstChild("SmoothSlider")
	if oldSlider then oldSlider:Destroy() end
end)

local sliderGUI = Instance.new("Frame", pages.Pvp)
sliderGUI.Size = UDim2.fromScale(0.6,0.1)
sliderGUI.Position = UDim2.fromScale(0.2,0.65)
sliderGUI.BackgroundColor3 = Color3.fromRGB(25,25,25)

local bar = Instance.new("Frame", sliderGUI)
bar.Size = UDim2.fromScale(1,0.25)
bar.Position = UDim2.fromScale(0,0.6)
bar.BackgroundColor3 = Color3.fromRGB(50,50,50)

local fill = Instance.new("Frame", bar)
fill.Size = UDim2.fromScale(0.24,1)
fill.BackgroundColor3 = Color3.fromRGB(80,180,80)

local smoothness = 0.12
local dragging = false

bar.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true end
end)
UIS.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)
UIS.InputChanged:Connect(function(i)
	if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
		local x = math.clamp((i.Position.X - bar.AbsolutePosition.X)/bar.AbsoluteSize.X,0.01,1)
		smoothness = x/5
		fill.Size = UDim2.fromScale(x,1)
	end
end)

-- Aimbot Logic
local holding = false
local targets = {}
local index = 1
local FOV = 250

local function getTargets()
	local list = {}
	for _,p in ipairs(Players:GetPlayers()) do
		if p ~= localPlayer and p.Character and p.Character:FindFirstChild("Head") then
			local head = p.Character.Head
			local pos, vis = Camera:WorldToViewportPoint(head.Position)
			if vis then
				local dist = (Vector2.new(pos.X,pos.Y) - Vector2.new(mouse.X,mouse.Y)).Magnitude
				if dist <= FOV then
					table.insert(list,{part=head,dist=dist})
				end
			end
		end
	end
	table.sort(list,function(a,b) return a.dist<b.dist end)
	return list
end

UIS.InputBegan:Connect(function(input,g)
	if g then return end
	if input.UserInputType == Enum.UserInputType.MouseButton2 and AimBotEnabled() then
		holding = true
		targets = getTargets()
		index = 1
	end
end)

UIS.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton2 then
		holding = false
		targets = {}
		index = 1
	end
end)

RunService.RenderStepped:Connect(function()
	if not AimBotEnabled() then return end
	if holding and targets[index] and targets[index].part and targets[index].part.Parent then
		local camPos = Camera.CFrame.Position
		local targetPos = targets[index].part.Position
		local newCFrame = CFrame.new(camPos,targetPos)
		if SmoothEnabled() then
			Camera.CFrame = Camera.CFrame:Lerp(newCFrame,smoothness)
		else
			Camera.CFrame = newCFrame
		end
	end
end)

-- Window controls
local minimized = false
minimize.MouseButton1Click:Connect(function()
	minimized = not minimized
	tabs.Visible = not minimized
	content.Visible = not minimized
	main.Size = minimized and UDim2.fromScale(0.45,0.12) or UDim2.fromScale(0.45,0.45)
	minimize.Text = minimized and "+" or "-"
end)

local dragging = false
local dragStart, startPos
titleBar.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = i.Position
		startPos = main.Position
	end
end)
titleBar.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging=false end
end)
UIS.InputChanged:Connect(function(i)
	if dragging and i.UserInputType==Enum.UserInputType.MouseMovement then
		local d = i.Position - dragStart
		main.Position = UDim2.new(startPos.X.Scale,startPos.X.Offset+d.X,startPos.Y.Scale,startPos.Y.Offset+d.Y)
	end
end)
UIS.InputBegan:Connect(function(i,g)
	if g then return end
	if i.KeyCode==Enum.KeyCode.H then main.Visible=not main.Visible end
end)
